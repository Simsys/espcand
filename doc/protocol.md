# Protocol

This document describes the protocol exchanged between the host and the CAN-WiFi bridge via TCP.

## Basics

The protocol uses the ASCII character set. Each piece of information or command begins with the $ sign followed by the command name  and ends with the <10> (next line) character. The command name may be followed by a comma-separated list of data before the next line character. Hexadezimale Daten werden mit Kleinbuchstaben bezeichnet.

The protocol can be output directly as a data stream in a terminal window. It is human-readable.

Commands sent from the host to the bridge are not confirmed by the bridge. However, incorrect commands are acknowledged with an error message. Data and information from the WiFi bridge are not confirmed by the host.

CAN Bus Frames:
- $rf Received Frame
- $fts Frame to Send

CAN Bus Filter Commands:
- $pfilt Define a positive Filter
- $nfilt Define a negative Filter
- $clearfilt Clear all Filters
- $filt? Show all Filters

Other Commands and Informations:
- $echo Echo commad
- $err Error information

In this document, the symbol <= is used to indicate communication from the host to the WiFi bridge, and => is used to indicate communication from the WiFi bridge to the host.

## CAN Bus Frames

A CAN bus frame consists of the ID, an info byte, and the data. The ID has a length of either 11 (CAN standard) or 29 (CAN extended) bits.

The info byte is bit-encoded:
- Bit 7: 1-Extended ID, 0-Standard ID
- Bit 6: 1-Remote Frame, 0-Data Frame
- Bits 4..5: reserved
- Bits 0..3: case remote frame: DLC, case standard frame: data length

The data can have a length of 0 to 8 bytes.

### $rf Received Frame

The datagrams received via CAN BUs are forwarded to the host via WiFi TCP stream.

Direction Wifi-Bridge => Host

```
$rf,<id>,<info>,<data><10>
```
Format:
- id Hexadecimal
- info Hexadecimal
- data Hexadecimal (length is always even)

Examples:

```
=> $rf,12a,3,1a2b3c
```

- Receifed frame
- ID 12a
- Info 3 (standard ID, data frame, 3 bytes data follow)

```
=> $rf,aa,94,1a2b3c4d
```

- Received frame
- ID aa
- Info 94 (extended ID, data frame, 4 bytes data follow)

```
=> Â§rf,8,44,
```

- Received frame
- Remote frame
- DLC 4

### $fts Frame to Send

The datagrams generated by the host are output on the CAN bus. The frames can be assigned a standard ID or extended ID. They can be data frames or remote frames.

Direction Wifi-Bridge <= Host

```
$fts,<id>,<info>,<data><10>
```
Format:
- id Hexadecimal
- info Hexadecimal
- data Hexadecimal (length is always even)

Example:

```
<= $fts,12a,5,1a2b3c4s5e
```

## CAN Bus Filter Commands

The WiFi bridge has a filter function. CAN bus systems typically communicate intensively and frequently. The filters can be used to reduce this data stream to the essentials. This protects the WiFi network and the host from unnecessary communication.

There are positive and negative filters for filtering. If a negative filter matches a CAN bus datagram, this datagram is discarded and not transmitted via TCP stream. The negative filters are applied first. This means that a datagram sorted out by a negative filter never appears in the data stream, even if this datagram would be matched by positive filters.

In addition to the match pattern, positive filters also have the option of specifying a minimum interval between datagrams in milliseconds. This allows the datagrams to be throttled to the frequency required for the application, which in turn reduces the data stream. A minimum interval of 0 milliseconds means that no time filtering is performed. The data streams defined by positive filters are added together.

Note: Since filters can match multiple IDs, a positive filter must remember when each individual ID was last received. A positive filter can remember the reception times for up to 16 IDs. Any datagrams beyond this are ignored. 

In the match pattern, each bit is addressed and defined as to whether it must be a 1 or a 0, or whether any state is accepted. Such a pattern must be either exactly 11 bits (standard ID) or 29 bits (extended ID) long. Underscores can be inserted for better readability.

Example:
```
Pattern 1*1_1010_010*
```
This pattern is defined for datagrams with a standard ID and matches the IDs 5a4, 5a5, 7a4 and 7a5.

Up to 10 positive and 10 negative filters can be defined.

### $pfilt Define a positive Filter

Define the throttle time and the match pattern for a positive Filter

Direction Wifi-Bridge <= Host

```
$pfilt,<duration>,<match-pattern><10>
```
Format:
- duration Decimal
- match-pattern see description

```
<= $pfilt,0,1*1_1010_010*
```
The WiFi bridge will then forward all datagrams with the IDs 5a5, 5a5, 7a4, and 7a5. All other datagrams will be suppressed.

```
<= $pfilt,10000,111_1010_1111
```
Datagrams with the ID 7af are forwarded at a maximum rate of once every 10 seconds.

### $nfilt Define a negative Filter

Define the match pattern for a nagitve Filter

Direction Wifi-Bridge <= Host

```
$nfilt,<match-pattern><10>
```
Format:
- match-pattern see description

Example:
```
<= $nfilt,1**_****_****
```
All datagrams with an ID > 7ff are discarded.

### $clearfilt Clear all Filters

Clear all filters.

Direction Wifi-Bridge <= Host

```
$clearfilt<10>
```

### $filt? Show all Filters

Show all filters defined by the pfilt and nfilt commands.

Direction Wifi-Bridge <= Host, answer from Wifi-Bridge => Host

```
$filt?<10>
```

Example:

```
<= $filt?
=> $pfilt,0,1*1_1010_010*
=> $pfilt,10000,111_1010_1111
=> $nfilt,1**_****_****
```

## Other Commands and Informations:

### $echo Echo commad

The echo command is always answered by the WiFi bridge and can be used to test whether a TCP connection exists, even if no CAN bus is available.

Direction Wifi-Bridge <= Host, answer from Wifi-Bridge => Host

```
$echo<10>
```

Example:

```
<= $echo
=> $echo
```

### $err Error information

The WiFi bridge responds with error messages when it cannot interpret commands or other error situations arise.

Direction Wifi-Bridge => Host

```
$err,<ErrorMessage><10>
```

Example:

```
<= Quatsch
=> $err,ParseError
```
